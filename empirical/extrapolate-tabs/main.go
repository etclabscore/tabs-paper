package main

import (
	"context"
	"flag"
	"fmt"
	"log"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/params"
)

var big1 = big.NewInt(1)

type output struct {
	blockNumber    *big.Int
	blockHash      common.Hash
	blockTAB       *big.Int
	blockTABS      *big.Int
	deltaMagnitude int // -1, 0, 1
}

func (o output) String() string {
	updownIcon := "↑"
	if o.deltaMagnitude == -1 {
		updownIcon = "↓"
	} else if o.deltaMagnitude == 0 {
		updownIcon = "→"
	}
	return fmt.Sprintf(`%s n=%v h=%s tab=%v tabs=%v`,
		updownIcon, o.blockNumber, o.blockHash.Hex()[:8], o.blockTAB, o.blockTABS)
}

func main() {
	rpcTarget := flag.String("target", "/tmp/geth.ipc", "URL for rpc endpoint")
	startBlock := flag.Int64("start", 0, "start block (inclusive)")
	endBlock := flag.Int64("end", 0, "end block (inclusive)")
	flag.Parse()

	c, err := ethclient.Dial(*rpcTarget)
	if err != nil {
		log.Fatalln(err)
	}

	ctx := context.Background()

	lastBlockTABS := new(big.Int).Mul(big.NewInt(7000), big.NewInt(params.Ether))

	for i := big.NewInt(*startBlock); i.Cmp(big.NewInt(*endBlock)) <= 0; i.Add(i, big1) {
		b, err := c.BlockByNumber(ctx, i)
		if err != nil {
			log.Fatalln(err)
		}

		tab := big.NewInt(0)
		prevBlockNumber := new(big.Int).Sub(i, big1)

		for txi, tx := range b.Transactions() {
			senderAddress, err := c.TransactionSender(ctx, tx, b.Hash(), uint(txi))
			if err != nil {
				log.Fatalln(err)
			}
			// tx sender balance at previous block.
			bal, err := c.BalanceAt(ctx, senderAddress, prevBlockNumber)
			if err != nil {
				log.Fatalln(err)
			}
			tab.Add(tab, bal)
		}

		minerBal, err := c.BalanceAt(ctx, b.Coinbase(), prevBlockNumber)
		if err != nil {
			log.Fatalln(err)
		}
		tab.Add(tab, minerBal)

		tabs := new(big.Int).Set(lastBlockTABS)

		delta := big.NewInt(0)
		tabCmp := tab.Cmp(lastBlockTABS)
		if tabCmp > 0 {
			delta.Div(lastBlockTABS, big.NewInt(2049))

		} else if tabCmp < 0 {
			delta.Div(lastBlockTABS, big.NewInt(-2049))

		} else {
			// noop on TABS (== lastBlockTABS)
		}

		tabs.Add(lastBlockTABS, delta)

		fmt.Println(output{
			blockNumber:    i,
			blockHash:      b.Hash(),
			blockTAB:       tab,
			blockTABS:      tabs,
			deltaMagnitude: tabCmp,
		}.String())

		lastBlockTABS.Set(tabs)
	}
}

/*
go run main.go -target https://classic.rpc.etccore.in -start 14961856 -end 14961936
↓ n=14961856 h=0x61c9d4 tab=6094560344849006393342 tabs=6996583699365544167887
↑ n=14961857 h=0x65d0d7 tab=15101778125072521463751 tabs=6999998332698567859525
↓ n=14961858 h=0x345e2b tab=579892257389488612288 tabs=6996582032877826733191
↑ n=14961859 h=0x6e5c8b tab=21300042813703429390979 tabs=6999996665397532846774
↑ n=14961860 h=0x66cda5 tab=15103467129523585147378 tabs=7003412964404559461145
↓ n=14961861 h=0xdbf85a tab=6097760344849006393342 tabs=6999994998096894961653
↑ n=14961862 h=0x5049ca tab=21386708878912789704207 tabs=7003411296290207257876
↓ n=14961863 h=0xf2912f tab=6100960344849006393342 tabs=6999993330796654204066
↑ n=14961864 h=0x5d3bde tab=7300009985867786138027 tabs=7003409628176252375956
↑ n=14961865 h=0x910df2 tab=21309911918830179390979 tabs=7006827592855694177994
↓ n=14961866 h=0x5bf7c8 tab=5233811472512046442695 tabs=7003407960062694815292
↓ n=14961867 h=0x2775bf tab=5184243799775716744802 tabs=6999989996197364071117
↑ n=14961868 h=0x69c06c tab=167864588262817568324139 tabs=7003406291949534575788
↑ n=14961869 h=0x846a15 tab=29632735235600595922782 tabs=7006824255000754456010
↑ n=14961870 h=0xb4dd7d tab=2759099311194059129991743 tabs=7010243886164737254670
↑ n=14961871 h=0x76b83e tab=80991580309975461847120 tabs=7013665186255593641812
↓ n=14961872 h=0x371ef0 tab=5241838373506924798261 tabs=7010242216423355675174
↓ n=14961873 h=0x5a67af tab=5274863809982669094419 tabs=7006820917147404793927
↑ n=14961874 h=0x306a34 tab=23383881713840872664058 tabs=7010240546682371804563
↑ n=14961875 h=0xc52780 tab=21832841108710525452825 tabs=7013661845143417374013
↑ n=14961876 h=0xcfae3a tab=21372577672668846051240 tabs=7017084813345049105283
↑ n=14961877 h=0x008fa0 tab=27097047612811988359659 tabs=7020509452102172116071
↓ n=14961878 h=0x492ccf tab=6093941455855826750187 tabs=7017083141974254999373
↑ n=14961879 h=0xd59c50 tab=19302406958761313624117 tabs=7020507779915677280973
↓ n=14961880 h=0x6898cd tab=5196038258329253466795 tabs=7017081470603858990451
↓ n=14961881 h=0xe2be18 tab=6097141455855826750187 tabs=7013656833478137243750
↑ n=14961882 h=0x7fa491 tab=21323841703192337314487 tabs=7017079799233861078422
↑ n=14961883 h=0x6858c9 tab=15054351212417983008705 tabs=7020504435543882484512
↑ n=14961884 h=0x4afdc8 tab=54496636147051380993543 tabs=7023930743223503705831
↓ n=14961885 h=0x4f2b6e tab=5199238258329253466795 tabs=7020502763358582522959
↓ n=14961886 h=0x3c1159 tab=6100341455855826750187 tabs=7017076456495059544666
↓ n=14961887 h=0x6619a3 tab=5255032976711413750182 tabs=7013651821816438236934
↓ n=14961888 h=0xc0bfe5 tab=6103541455855826750187 tabs=7010228858506620551119
↑ n=14961889 h=0x195da3 tab=27935512038320974034132 tabs=7013650151263334372764
↑ n=14961890 h=0xf741dc tab=122134829117116535003740 tabs=7017073113757850397348
↑ n=14961891 h=0xe9497e tab=27100247612811988359659 tabs=7020497746805072383876
↓ n=14961892 h=0x5271e6 tab=6973199399724429325404 tabs=7017071442389842968365
↑ n=14961893 h=0x52d4f3 tab=33668528601957089103591 tabs=7020496074621365585723
↓ n=14961894 h=0x3742af tab=6100619050745311706492 tabs=7017069771022233635706
↓ n=14961895 h=0x40ff1a tab=961502715272046169879 tabs=7013645139606410193229
↑ n=14961896 h=0xae5571 tab=18986148559459042899013 tabs=7017068099655022399277
↓ n=14961897 h=0xda8d1d tab=5207138970062454743142 tabs=7013643469054897937394
↓ n=14961898 h=0x2eec2d tab=325798498739505227359 tabs=7010220509821586615805
↓ n=14961899 h=0xaf657a tab=6103819050745311706492 tabs=7006799221139389648204
↓ n=14961900 h=0xb99e60 tab=6107019050745311706492 tabs=7003379602193006344325
↓ n=14961901 h=0xf798fa tab=6110219050745311706492 tabs=6999961652167533915656
↑ n=14961902 h=0xc8444a tab=25476872803636011367483 tabs=7003377934086600550070
↓ n=14961903 h=0x453bd2 tab=5208838710778753466795 tabs=6999959984875235688894
↓ n=14961904 h=0xae0eff tab=5212038710778753466795 tabs=6996543703769879302516
↑ n=14961905 h=0xbabd02 tab=15057716332074521990333 tabs=6999958317583334587680
↑ n=14961906 h=0xcd9706 tab=21347227071321193872227 tabs=7003374597874980919836
↓ n=14961907 h=0xde0e25 tab=6439083703288352888673 tabs=6999956650291830611921
↓ n=14961908 h=0x3b5588 tab=1127168781326874697420 tabs=6996540370813894140173
↑ n=14961909 h=0x2deff2 tab=27103547612811988359659 tabs=6999954983000723761520
↑ n=14961910 h=0x095f70 tab=15063763265163199425713 tabs=7003371261664950566674
↓ n=14961911 h=0x584149 tab=6113419050745311706492 tabs=6999953315710014036383
↓ n=14961912 h=0x8b6dc6 tab=5230087559573433164054 tabs=6996537037859496704008
↑ n=14961913 h=0x7f7cc1 tab=21338557100251193872227 tabs=6999951648419701436416
↓ n=14961914 h=0xa27062 tab=286574397859603164770 tabs=6996535371382893383007
↓ n=14961915 h=0x3ca86c tab=5223081741676753466795 tabs=6993120761636000804490
↓ n=14961916 h=0x515cb7 tab=5240713826746753466795 tabs=6989707818365314615713
↑ n=14961917 h=0xa9d4a6 tab=158807180534334823133319 tabs=6993119095973106374920
↑ n=14961918 h=0x862766 tab=27106747612811988359659 tabs=6996532038430877534693
↓ n=14961919 h=0x69ed99 tab=5300019430186737770300 tabs=6993117430310608682798
↑ n=14961920 h=0x6ba478 tab=7325394978273725754637 tabs=6996530371955465007191
↓ n=14961921 h=0xd8b05a tab=6099118132303904062869 tabs=6993115764648507728027
↓ n=14961922 h=0xae4dff tab=6102318132303904062869 tabs=6989702823816566045388
↓ n=14961923 h=0x35c96e tab=5263341450159366506295 tabs=6986291548646328580261
↓ n=14961924 h=0xa0f4c6 tab=6105518132303904062869 tabs=6982881938324880884517
↓ n=14961925 h=0xf028c8 tab=6108718132303904062869 tabs=6979473992039705247190
↑ n=14961926 h=0xa08434 tab=816131588488527198782728 tabs=6982880275100729993528
↓ n=14961927 h=0xe0a769 tab=878606647946587972333 tabs=6979472329627279173620
↑ n=14961928 h=0xbb6466 tab=14252636969483543353423 tabs=6982878611876975259112
↓ n=14961929 h=0x1baf05 tab=6111918132303904062869 tabs=6979470667215249063281
↑ n=14961930 h=0xcdfb0d tab=27109947612811988359659 tabs=6982876948653616681174
↓ n=14961931 h=0xb3e809 tab=1096851299885860017448 tabs=6979469004803614916079
↓ n=14961932 h=0x40b5bd tab=6115118132303904062869 tabs=6976062724176575572538
↓ n=14961933 h=0x5f177c tab=6118318132303904062869 tabs=6972658105960774413157
↑ n=14961934 h=0x28929d tab=7314764211865129563346 tabs=6976061062576665469483
↓ n=14961935 h=0x1a8baf tab=286061799374256036998 tabs=6972656445171796428259
↑ n=14961936 h=0xdf99c5 tab=23738921089527745073162 tabs=6976059400977151136130
*/
